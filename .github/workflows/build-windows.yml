name: Build Windows Installer

on:
  push:
    branches: [ main, master ]
    tags:
      - 'v*'
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:  # Allow manual trigger

jobs:
  build:
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        cache: 'pip'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pyinstaller pillow
    
    - name: Create application icon
      run: |
        python -c "
        from PIL import Image, ImageDraw
        
        size = 256
        img = Image.new('RGBA', (size, size), (0, 0, 0, 0))
        draw = ImageDraw.Draw(img)
        
        # Background circle
        draw.ellipse([10, 10, size-10, size-10], fill='#1a2332', outline='#f59e0b', width=8)
        
        # Scale/Balance icon
        draw.rectangle([80, 180, 176, 200], fill='#f59e0b')  # Base
        draw.rectangle([118, 80, 138, 180], fill='#f59e0b')   # Pillar
        draw.rectangle([40, 65, 216, 80], fill='#f59e0b')     # Beam
        draw.ellipse([35, 90, 95, 120], fill='#3b82f6')       # Left pan
        draw.ellipse([161, 90, 221, 120], fill='#3b82f6')     # Right pan
        draw.line([65, 75, 65, 90], fill='#f59e0b', width=3)  # Left chain
        draw.line([191, 75, 191, 90], fill='#f59e0b', width=3) # Right chain
        
        img.save('icon.ico', format='ICO', sizes=[(256,256), (128,128), (64,64), (48,48), (32,32), (16,16)])
        print('Icon created successfully')
        "
    
    - name: Build executable with PyInstaller
      run: |
        pyinstaller --clean LitigationTracker.spec
    
    - name: Create uploads directory in dist
      run: |
        New-Item -ItemType Directory -Force -Path "dist\LitigationTracker\uploads"
    
    - name: Install Inno Setup
      run: |
        choco install innosetup -y
    
    - name: Build Windows Installer
      run: |
        & "C:\Program Files (x86)\Inno Setup 6\ISCC.exe" installer.iss
    
    - name: Get version from tag or commit
      id: version
      run: |
        if ("${{ github.ref }}" -like "refs/tags/v*") {
          $version = "${{ github.ref }}".Replace("refs/tags/v", "")
        } else {
          $version = "${{ github.sha }}".Substring(0, 7)
        }
        echo "VERSION=$version" >> $env:GITHUB_OUTPUT
        echo "Version: $version"
    
    - name: Upload executable artifact
      uses: actions/upload-artifact@v4
      with:
        name: LitigationTracker-Portable-${{ steps.version.outputs.VERSION }}
        path: dist/LitigationTracker/
        retention-days: 30
    
    - name: Upload installer artifact
      uses: actions/upload-artifact@v4
      with:
        name: LitigationTracker-Installer-${{ steps.version.outputs.VERSION }}
        path: installer_output/*.exe
        retention-days: 30

  release:
    needs: build
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    
    steps:
    - name: Download installer artifact
      uses: actions/download-artifact@v4
      with:
        name: LitigationTracker-Installer-${{ github.ref_name }}
        path: installer
    
    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        files: installer/*.exe
        draft: false
        prerelease: false
        generate_release_notes: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

