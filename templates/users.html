{% extends "base.html" %}

{% block title %}User Management - Litigation Tracker{% endblock %}

{% block content %}
<div class="page-header">
    <div>
        <h1 class="page-title">User Management</h1>
        <p class="page-subtitle">{{ user_count }} / {{ max_users }} active users</p>
    </div>
    {% if user_count < max_users %}
    <button class="btn btn-primary" onclick="openModal('add-user-modal')">‚ûï Add User</button>
    {% else %}
    <span class="badge badge-warning" style="padding: 10px 16px;">Maximum user limit reached</span>
    {% endif %}
</div>

<div class="card">
    <div class="table-container">
        <table>
            <thead>
                <tr>
                    <th>User</th>
                    <th>Username</th>
                    <th>Email</th>
                    <th>Role</th>
                    <th>Status</th>
                    <th>Created</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for u in users %}
                <tr>
                    <td>
                        <div class="flex gap-1" style="align-items: center;">
                            <div class="user-avatar" style="width: 36px; height: 36px; font-size: 12px;">{{ u.full_name[0] }}</div>
                            <strong>{{ u.full_name }}</strong>
                        </div>
                    </td>
                    <td><code style="color: var(--accent-primary);">{{ u.username }}</code></td>
                    <td>{{ u.email }}</td>
                    <td><span class="badge badge-{{ u.role }}">{{ u.role|upper }}</span></td>
                    <td>
                        {% if u.is_active %}
                        <span class="badge badge-active">Active</span>
                        {% else %}
                        <span class="badge badge-inactive">Inactive</span>
                        {% endif %}
                    </td>
                    <td>{{ u.created_at.strftime('%d %b %Y') }}</td>
                    <td>
                        {% if u.id != user.id %}
                        <div class="flex gap-1">
                            <button type="button" class="btn btn-sm btn-secondary btn-icon" title="Reset Password" onclick="openResetModal({{ u.id }}, '{{ u.username }}')">üîë</button>
                            <form method="POST" action="/users/{{ u.id }}/toggle" style="display: inline;">
                                <button type="submit" class="btn btn-sm btn-secondary btn-icon" title="{{ 'Deactivate' if u.is_active else 'Activate' }}">
                                    {{ 'üö´' if u.is_active else '‚úÖ' }}
                                </button>
                            </form>
                            <form method="POST" action="/users/{{ u.id }}/delete" style="display: inline;" onsubmit="return confirm('Are you sure you want to delete this user?')">
                                <button type="submit" class="btn btn-sm btn-danger btn-icon" title="Delete">üóëÔ∏è</button>
                            </form>
                        </div>
                        {% else %}
                        <a href="/profile" class="btn btn-sm btn-secondary">Change Password</a>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- Add User Modal -->
<div id="add-user-modal" class="modal-backdrop">
    <div class="modal">
        <div class="modal-header">
            <h3 class="modal-title">Add New User</h3>
            <button class="modal-close" onclick="closeModal('add-user-modal')">&times;</button>
        </div>
        <form method="POST" action="/users">
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label" for="full_name">Full Name *</label>
                    <input type="text" id="full_name" name="full_name" class="form-input" required placeholder="John Doe">
                </div>
                <div class="form-group">
                    <label class="form-label" for="username">Username *</label>
                    <input type="text" id="username" name="username" class="form-input" required placeholder="johndoe" pattern="[a-zA-Z0-9_]+" title="Only letters, numbers, and underscores">
                </div>
                <div class="form-group">
                    <label class="form-label" for="email">Email *</label>
                    <input type="email" id="email" name="email" class="form-input" required placeholder="john@example.com">
                </div>
                <div class="form-group">
                    <label class="form-label" for="password">Password *</label>
                    <input type="password" id="password" name="password" class="form-input" required placeholder="Min. 6 characters" minlength="6">
                </div>
                <div class="form-group">
                    <label class="form-label" for="role">Role</label>
                    <select id="role" name="role" class="form-select">
                        <option value="user">User</option>
                        <option value="admin">Admin</option>
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeModal('add-user-modal')">Cancel</button>
                <button type="submit" class="btn btn-primary">Create User</button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

<!-- Reset Password Modal -->
<div id="reset-password-modal" class="modal-backdrop">
    <div class="modal">
        <div class="modal-header">
            <h3 class="modal-title">üîë Reset Password</h3>
            <button class="modal-close" onclick="closeModal('reset-password-modal')">&times;</button>
        </div>
        <form method="POST" id="reset-password-form">
            <div class="modal-body">
                <p style="color: var(--text-muted); margin-bottom: 16px;">
                    Reset password for user: <strong id="reset-username" style="color: var(--accent-primary);"></strong>
                </p>
                <div class="form-group">
                    <label class="form-label" for="reset_new_password">New Password *</label>
                    <input type="password" id="reset_new_password" name="new_password" class="form-input" 
                           required placeholder="Enter new password (min. 6 characters)" minlength="6">
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeModal('reset-password-modal')">Cancel</button>
                <button type="submit" class="btn btn-primary">Reset Password</button>
            </div>
        </form>
    </div>
</div>

{% block scripts %}
<script>
function openModal(modalId) {
    document.getElementById(modalId).classList.add('active');
}

function closeModal(modalId) {
    document.getElementById(modalId).classList.remove('active');
}

function openResetModal(userId, username) {
    document.getElementById('reset-username').textContent = username;
    document.getElementById('reset-password-form').action = '/users/' + userId + '/reset-password';
    document.getElementById('reset_new_password').value = '';
    openModal('reset-password-modal');
}

// Close modal when clicking outside
document.querySelectorAll('.modal-backdrop').forEach(backdrop => {
    backdrop.addEventListener('click', function(e) {
        if (e.target === this) {
            this.classList.remove('active');
        }
    });
});
</script>
{% endblock %}

